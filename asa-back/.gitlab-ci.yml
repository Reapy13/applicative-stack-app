include:
  - local: common/cicd-functions/common.yml
  - local: common/cicd-functions/helm.yml
  - local: common/cicd-functions/kaniko.yml

image: maven:3.9.6-eclipse-temurin-21
before_script:
    - cd asa-back

variables:
  ASA_PROJECT_DIR: "${CI_PROJECT_DIR}/asa-back"
  APP_NAME: asa-back

stages:
  - prepare
  - test
  - package
  - release
  - deploy


get-version:
  extends: .get-version
  script:
    - |
      if [ ${CI_COMMIT_TAG} ]; then
        VERSION=${CI_COMMIT_TAG}
      else
        VERSION="$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression=project.version -q -DforceStdout)-${CI_COMMIT_SHORT_SHA}"
      fi
    - echo "VERSION=${VERSION}" >> prepare.env


test:
  stage: test
  script:
    - mvn clean verify
  rules:
    - when: on_success


build:
  stage: package
  needs: [test]
  image: 
    name: ${NEXUS_DOCKER_REPOSITORY_URL}:${NEXUS_DOCKER_REPOSITORY_PORT}/quarkus-cli:latest
  script:
    - quarkus build --native --no-tests -Dquarkus.native.container-build=true
  artifacts:
    paths:
      - asa-back/target/*-runner
  rules:
    - when: on_success


build-and-publish-docker-image:
  extends: .kaniko-build-and-publish
  variables:
    DOCKERFILE_PATH: ${CONTEXT_DIR}/Dockerfile

publish-helm-chart:
  extends: .publish-helm-chart
  needs: [get-version, build-and-publish-docker-image]


deploy:
  extends: .deploy-helm-chart