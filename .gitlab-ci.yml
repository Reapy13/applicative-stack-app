include:
  - local: common/cicd-functions/kaniko.yml
  - local: common/cicd-functions/sonarqube.yml

stages:
  - release-docker-images
  - trigger-child-pipelines
  - analyse


release-docker-images:
  stage: release-docker-images
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
  variables:
    CONTEXT_DIR: ${CI_PROJECT_DIR}/common/docker-images
    DOCKERFILE_PATH: "${CONTEXT_DIR}/Dockerfile.quarkus-cli"
    IMAGE_NAME: "${NEXUS_DOCKER_REPOSITORY_URL}/quarkus-cli"
    IMAGE_VERSION: "latest"
  before_script:
    - cd common/docker-images
    - !reference [.kaniko-build-and-publish, before_script]
  script:
    - !reference [.kaniko-build-and-publish, script]
  only:
      changes:
        - common/docker-images/**/*
  rules:
    - if: '$CI_JOB_MANUAL != "true"'

asa-ng:
  stage: trigger-child-pipelines
  trigger:
    include: asa-ng/.gitlab-ci.yml
    strategy: depend
  only:
    changes:
      - asa-ng/**/*

asa-back:
  stage: trigger-child-pipelines
  trigger:
    include: asa-back/.gitlab-ci.yml
    strategy: depend
  only:
    changes:
      - asa-back/**/*


sonarqube-check:
  extends: .sonarqube-check
  rules:
    - changes:
      - asa-ng/**/*
      - asa-back/**/*